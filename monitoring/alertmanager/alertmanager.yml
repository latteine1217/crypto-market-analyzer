# Alertmanager é…ç½®æª”æ¡ˆ
# ç”¨æ–¼è™•ç†å‘Šè­¦é€šçŸ¥

global:
  resolve_timeout: 5m
  # SMTP é…ç½®ï¼ˆå¾ç’°å¢ƒè®Šæ•¸è®€å–ï¼‰
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'felix.tc.tw@gmail.com'
  smtp_auth_username: 'felix.tc.tw@gmail.com'
  smtp_auth_password: 'gvntbgaobsmsugdv'
  smtp_require_tls: true

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'email-notifications'  # Phase 7 Gate 3: é è¨­ä½¿ç”¨ email é©—è­‰å‘Šè­¦ç³»çµ±

  # å­è·¯ç”±ï¼ˆæ ¹æ“šåš´é‡ç¨‹åº¦åˆ†é¡ï¼‰
  routes:
    # åš´é‡å‘Šè­¦ â†’ email-critical
    - match:
        severity: critical
      receiver: 'email-critical'
      continue: false

    # è­¦å‘Šç´šåˆ¥ â†’ email-warning
    - match:
        severity: warning
      receiver: 'email-warning'
      continue: false

# æ¥æ”¶å™¨é…ç½®
receivers:
  # Email é€šçŸ¥ï¼ˆä¸€èˆ¬å‘Šè­¦ï¼‰
  - name: 'email-notifications'
    email_configs:
      - to: 'felix.tc.tw@gmail.com'
        headers:
          Subject: '[Crypto Analyzer] Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2>å‘Šè­¦é€šçŸ¥</h2>
          <p><strong>å‘Šè­¦åç¨±ï¼š</strong>{{ .GroupLabels.alertname }}</p>
          <p><strong>åš´é‡ç¨‹åº¦ï¼š</strong>{{ .GroupLabels.severity }}</p>
          <p><strong>çµ„ä»¶ï¼š</strong>{{ .GroupLabels.component }}</p>
          <hr>
          {{ range .Alerts }}
          <h3>{{ .Annotations.summary }}</h3>
          <p>{{ .Annotations.description }}</p>
          <p><strong>ç‹€æ…‹ï¼š</strong>{{ .Status }}</p>
          <p><strong>æ™‚é–“ï¼š</strong>{{ .StartsAt }}</p>
          <hr>
          {{ end }}

  # Email é€šçŸ¥ï¼ˆåš´é‡å‘Šè­¦ï¼‰
  - name: 'email-critical'
    email_configs:
      - to: 'felix.tc.tw@gmail.com'
        headers:
          Subject: '[CRITICAL] Crypto Analyzer Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2 style="color: red;">ğŸš¨ åš´é‡å‘Šè­¦</h2>
          <p><strong>å‘Šè­¦åç¨±ï¼š</strong>{{ .GroupLabels.alertname }}</p>
          <p><strong>çµ„ä»¶ï¼š</strong>{{ .GroupLabels.component }}</p>
          <hr>
          {{ range .Alerts }}
          <h3>{{ .Annotations.summary }}</h3>
          <p>{{ .Annotations.description }}</p>
          <p><strong>ç‹€æ…‹ï¼š</strong>{{ .Status }}</p>
          <p><strong>æ™‚é–“ï¼š</strong>{{ .StartsAt }}</p>
          <hr>
          {{ end }}
          <p><em>è«‹ç«‹å³è™•ç†æ­¤å‘Šè­¦ï¼</em></p>

  # Email é€šçŸ¥ï¼ˆè­¦å‘Šå‘Šè­¦ï¼‰
  - name: 'email-warning'
    email_configs:
      - to: 'felix.tc.tw@gmail.com'
        headers:
          Subject: '[WARNING] Crypto Analyzer Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2 style="color: orange;">âš ï¸ è­¦å‘Šå‘Šè­¦</h2>
          <p><strong>å‘Šè­¦åç¨±ï¼š</strong>{{ .GroupLabels.alertname }}</p>
          <p><strong>çµ„ä»¶ï¼š</strong>{{ .GroupLabels.component }}</p>
          <hr>
          {{ range .Alerts }}
          <h3>{{ .Annotations.summary }}</h3>
          <p>{{ .Annotations.description }}</p>
          <p><strong>ç‹€æ…‹ï¼š</strong>{{ .Status }}</p>
          <p><strong>æ™‚é–“ï¼š</strong>{{ .StartsAt }}</p>
          <hr>
          {{ end }}

  # Webhook æ¥æ”¶å™¨ï¼ˆå‚™ç”¨ - å¸¶ K ç·šåœ–ç”Ÿæˆï¼‰
  - name: 'webhook-with-charts'
    webhook_configs:
      - url: 'http://host.docker.internal:9100/webhook/alerts'
        send_resolved: true
        http_config:
          follow_redirects: true

# æŠ‘åˆ¶è¦å‰‡
inhibit_rules:
  # ç•¶ Collector æœå‹™åœæ­¢æ™‚ï¼ŒæŠ‘åˆ¶æ‰€æœ‰ Collector ç›¸é—œå‘Šè­¦
  - source_match:
      alertname: 'CollectorProcessDown'
    target_match_re:
      alertname: '(NoKLineDataFor30Minutes|HighAPIErrorRate|LowDatabaseWriteRate)'
    equal: ['instance']

  # ç•¶ PostgreSQL åœæ­¢æ™‚ï¼ŒæŠ‘åˆ¶è³‡æ–™åº«ç›¸é—œå‘Šè­¦
  - source_match:
      alertname: 'PostgreSQLDown'
    target_match_re:
      alertname: '(LowDatabaseWriteRate|HighDataMissingRate)'
    equal: ['instance']
