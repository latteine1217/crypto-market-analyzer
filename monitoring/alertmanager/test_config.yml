# Alertmanager 測試環境配置
# 用於長期運行測試的告警通知

global:
  # 告警解決後等待時間
  resolve_timeout: 5m

# 告警路由配置
route:
  # 預設接收器
  receiver: 'test-console'

  # 分組標籤
  group_by: ['alertname', 'cluster', 'test_category']

  # 分組等待時間
  group_wait: 10s

  # 分組間隔時間
  group_interval: 10s

  # 重複告警間隔
  repeat_interval: 3h

  # 子路由
  routes:
    # 嚴重告警 - 立即通知
    - match:
        severity: critical
      receiver: 'test-critical'
      group_wait: 0s
      repeat_interval: 5m

    # 穩定性測試相關
    - match:
        test_category: stability
      receiver: 'test-stability'
      group_by: ['alertname', 'component']

    # 性能測試相關
    - match:
        test_category: performance
      receiver: 'test-performance'
      group_by: ['alertname', 'component']

    # 資料品質相關
    - match:
        test_category: data_quality
      receiver: 'test-data-quality'

# 接收器配置
receivers:
  # 控制台輸出（預設）
  - name: 'test-console'
    webhook_configs:
      - url: 'http://localhost:9099/webhook'
        send_resolved: true

  # 嚴重告警
  - name: 'test-critical'
    webhook_configs:
      - url: 'http://localhost:9099/webhook/critical'
        send_resolved: true
    # 可配置 email 或其他通知方式
    # email_configs:
    #   - to: 'your-email@example.com'
    #     from: 'alertmanager@crypto-analyzer.local'
    #     smarthost: 'smtp.gmail.com:587'
    #     auth_username: 'your-email@example.com'
    #     auth_password: 'your-app-password'
    #     headers:
    #       subject: '[CRITICAL] {{ .GroupLabels.alertname }}'

  # 穩定性測試告警
  - name: 'test-stability'
    webhook_configs:
      - url: 'http://localhost:9099/webhook/stability'
        send_resolved: true

  # 性能測試告警
  - name: 'test-performance'
    webhook_configs:
      - url: 'http://localhost:9099/webhook/performance'
        send_resolved: true

  # 資料品質告警
  - name: 'test-data-quality'
    webhook_configs:
      - url: 'http://localhost:9099/webhook/data_quality'
        send_resolved: true

# 抑制規則
inhibit_rules:
  # 當容器停止時，抑制該容器的其他告警
  - source_match:
      alertname: 'CollectorProcessDown'
    target_match_re:
      alertname: '.*'
    equal:
      - instance

  # 當系統資源嚴重不足時，抑制性能警告
  - source_match:
      severity: 'critical'
      test_category: 'performance'
    target_match:
      severity: 'warning'
      test_category: 'performance'
    equal:
      - component
