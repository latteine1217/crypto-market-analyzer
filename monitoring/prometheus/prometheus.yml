# Prometheus 配置檔案
# 用於監控 Crypto Market Analyzer 系統

global:
  scrape_interval: 15s  # 每 15 秒抓取一次指標
  evaluation_interval: 15s  # 每 15 秒評估一次告警規則
  external_labels:
    cluster: 'crypto-analyzer'
    environment: 'production'

# Alertmanager 配置
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# 告警規則檔案
rule_files:
  - '/etc/prometheus/rules/*.yml'

# 抓取目標配置
scrape_configs:
  # Prometheus 自身監控
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # TimescaleDB / PostgreSQL Exporter
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'timescaledb'

  # Redis Exporter
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'redis'

  # Collector (Python) - 自定義指標
  - job_name: 'collector'
    static_configs:
      - targets: ['collector:8000']
    metrics_path: '/metrics'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'collector'

  # WebSocket Collector (Node.js) - 自定義指標
  - job_name: 'ws-collector'
    static_configs:
      - targets: ['ws-collector:8001']
    metrics_path: '/metrics'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'ws-collector'

  # Node Exporter (系統指標)
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']

  # MAD Anomaly Detector - MAD 異常檢測服務
  - job_name: 'mad-detector'
    static_configs:
      - targets: ['mad-detector:8002']
    metrics_path: '/metrics'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'mad-detector'

  # Retention Monitor - 資料保留策略監控 (運行在宿主機)
  - job_name: 'retention-monitor'
    static_configs:
      - targets: ['host.docker.internal:8003']
    metrics_path: '/metrics'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'retention-monitor'
