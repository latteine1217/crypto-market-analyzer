# Prometheus 告警規則
# Phase 6.3: 3 個核心告警規則

groups:
  - name: collector_alerts
    interval: 60s
    rules:
      # Alert 1: 超過 30 分鐘沒有成功抓到任何 K 線
      - alert: NoKLineDataFor30Minutes
        expr: |
          (time() - max(collector_last_success_timestamp_seconds)) > 1800
        for: 5m
        labels:
          severity: critical
          component: collector
        annotations:
          summary: "Collector 超過 30 分鐘未成功收集 K 線數據"
          description: "Collector 最後一次成功收集時間：{{ $value | humanizeDuration }} 前"

      # Alert 2: 某 symbol 當日缺失率 > 0.1% (根據 AGENTS.md 標準)
      - alert: HighDataMissingRate
        expr: |
          collector_missing_data_rate > 0.001
        for: 5m
        labels:
          severity: warning
          component: quality
        annotations:
          summary: "{{ $labels.symbol }} 資料缺失率超過標準 (0.1%)"
          description: "{{ $labels.symbol }} 當前缺失率：{{ $value | printf \"%.4f%%\" }}（閾值：0.1%）"

      # Alert 3: Collector 程式異常退出
      - alert: CollectorProcessDown
        expr: |
          up{job="collector"} == 0
        for: 3m
        labels:
          severity: critical
          component: collector
        annotations:
          summary: "Collector 服務停止運行"
          description: "Collector ({{ $labels.instance }}) 已經停止運行超過 3 分鐘"

  - name: api_alerts
    interval: 60s
    rules:
      # API 錯誤率過高
      - alert: HighAPIErrorRate
        expr: |
          (
            rate(collector_api_errors_total[1h])
            /
            rate(collector_api_requests_total[1h])
          ) > 0.1
        for: 10m
        labels:
          severity: warning
          component: collector
        annotations:
          summary: "API 錯誤率過高"
          description: "過去 1 小時 API 錯誤率：{{ $value | printf \"%.2f%%\" }}（閾值：10%）"

  - name: database_alerts
    interval: 60s
    rules:
      # DB 寫入速率異常低 (6個市場，1m間隔預期 0.1 rows/sec)
      - alert: LowDatabaseWriteRate
        expr: |
          (rate(collector_db_writes_total[5m]) < 0.05)
          and
          (rate(collector_db_writes_total[5m]) > 0)
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "資料庫寫入速率異常低"
          description: "過去 5 分鐘平均寫入：{{ $value | printf \"%.4f\" }} rows/sec（閾值：0.05），低於 6 個市場的預期，資料收集可能有缺漏"

      # 資料收集完全停止（更嚴重的情況）
      - alert: DatabaseWriteStopped
        expr: |
          rate(collector_db_writes_total[10m]) == 0
        for: 10m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "資料庫寫入完全停止"
          description: "過去 10 分鐘沒有任何資料寫入，收集器可能已停止運行"

  - name: system_alerts
    interval: 60s
    rules:
      # Redis 連線中斷
      - alert: RedisDown
        expr: |
          up{job="redis"} == 0
        for: 3m
        labels:
          severity: critical
          component: redis
        annotations:
          summary: "Redis 服務停止運行"
          description: "Redis 已經停止運行超過 3 分鐘"

      # PostgreSQL 連線中斷
      - alert: PostgreSQLDown
        expr: |
          up{job="postgres"} == 0
        for: 3m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "PostgreSQL 服務停止運行"
          description: "PostgreSQL 已經停止運行超過 3 分鐘"

  # 價格變動告警
  - name: price_alerts
    interval: 30s
    rules:
      # 價格急劇上漲（5 分鐘內漲幅超過 3%）
      - alert: PriceSpike
        expr: |
          (
            (price_current{symbol=~"BTC.*|ETH.*"} - price_current{symbol=~"BTC.*|ETH.*"} offset 5m)
            / price_current{symbol=~"BTC.*|ETH.*"} offset 5m
          ) * 100 > 3
        for: 1m
        labels:
          severity: warning
          component: price_monitor
        annotations:
          summary: "{{ $labels.symbol }} 價格急劇上漲"
          description: "{{ $labels.symbol }} 在 5 分鐘內上漲 {{ $value | printf \"%.2f%%\" }}（當前價格：{{ $labels.price }}）"

      # 價格急劇下跌（5 分鐘內跌幅超過 3%）
      - alert: PriceDrop
        expr: |
          (
            (price_current{symbol=~"BTC.*|ETH.*"} - price_current{symbol=~"BTC.*|ETH.*"} offset 5m)
            / price_current{symbol=~"BTC.*|ETH.*"} offset 5m
          ) * 100 < -3
        for: 1m
        labels:
          severity: warning
          component: price_monitor
        annotations:
          summary: "{{ $labels.symbol }} 價格急劇下跌"
          description: "{{ $labels.symbol }} 在 5 分鐘內下跌 {{ $value | printf \"%.2f%%\" }}（當前價格：{{ $labels.price }}）"

      # 價格極端波動（5 分鐘內漲跌幅超過 5%）
      - alert: ExtremePriceVolatility
        expr: |
          abs(
            (price_current{symbol=~"BTC.*|ETH.*"} - price_current{symbol=~"BTC.*|ETH.*"} offset 5m)
            / price_current{symbol=~"BTC.*|ETH.*"} offset 5m
          ) * 100 > 5
        for: 30s
        labels:
          severity: critical
          component: price_monitor
        annotations:
          summary: "{{ $labels.symbol }} 價格極端波動"
          description: "{{ $labels.symbol }} 在 5 分鐘內波動 {{ $value | printf \"%.2f%%\" }}（當前價格：{{ $labels.price }}）⚠️ 需要立即關注！"

      # 價格異常停滯（10 分鐘內價格無變化）
      - alert: PriceStagnant
        expr: |
          (
            price_current{symbol=~"BTC.*|ETH.*"} == price_current{symbol=~"BTC.*|ETH.*"} offset 10m
          )
        for: 5m
        labels:
          severity: warning
          component: price_monitor
        annotations:
          summary: "{{ $labels.symbol }} 價格異常停滯"
          description: "{{ $labels.symbol }} 價格在過去 10 分鐘內沒有變化（當前價格：{{ $labels.price }}），可能是數據源問題"
