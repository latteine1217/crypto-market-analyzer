# Prometheus å‘Šè­¦è¦å‰‡
# Phase 6.3: 3 å€‹æ ¸å¿ƒå‘Šè­¦è¦å‰‡

groups:
  - name: collector_alerts
    interval: 60s
    rules:
      # Alert 1: è¶…é 30 åˆ†é˜æ²’æœ‰æˆåŠŸæŠ“åˆ°ä»»ä½• K ç·š
      - alert: NoKLineDataFor30Minutes
        expr: |
          (time() - max(collector_last_success_timestamp_seconds)) > 1800
        for: 5m
        labels:
          severity: critical
          component: collector
        annotations:
          summary: "Collector è¶…é 30 åˆ†é˜æœªæˆåŠŸæ”¶é›† K ç·šæ•¸æ“š"
          description: "Collector æœ€å¾Œä¸€æ¬¡æˆåŠŸæ”¶é›†æ™‚é–“ï¼š{{ $value | humanizeDuration }} å‰"

      # Alert 2: æŸ symbol ç•¶æ—¥ç¼ºå¤±ç‡ > 5%
      - alert: HighDataMissingRate
        expr: |
          collector_missing_data_rate{period="daily"} > 0.05
        for: 10m
        labels:
          severity: warning
          component: quality
        annotations:
          summary: "{{ $labels.symbol }} ç•¶æ—¥è³‡æ–™ç¼ºå¤±ç‡éé«˜"
          description: "{{ $labels.symbol }} ç•¶æ—¥ç¼ºå¤±ç‡ï¼š{{ $value | printf \"%.2f%%\" }}ï¼ˆé–¾å€¼ï¼š5%ï¼‰"

      # Alert 3: Collector ç¨‹å¼ç•°å¸¸é€€å‡º
      - alert: CollectorProcessDown
        expr: |
          up{job="collector"} == 0
        for: 3m
        labels:
          severity: critical
          component: collector
        annotations:
          summary: "Collector æœå‹™åœæ­¢é‹è¡Œ"
          description: "Collector ({{ $labels.instance }}) å·²ç¶“åœæ­¢é‹è¡Œè¶…é 3 åˆ†é˜"

  - name: api_alerts
    interval: 60s
    rules:
      # API éŒ¯èª¤ç‡éé«˜
      - alert: HighAPIErrorRate
        expr: |
          (
            rate(collector_api_errors_total[1h])
            /
            rate(collector_api_requests_total[1h])
          ) > 0.1
        for: 10m
        labels:
          severity: warning
          component: collector
        annotations:
          summary: "API éŒ¯èª¤ç‡éé«˜"
          description: "éå» 1 å°æ™‚ API éŒ¯èª¤ç‡ï¼š{{ $value | printf \"%.2f%%\" }}ï¼ˆé–¾å€¼ï¼š10%ï¼‰"

  - name: database_alerts
    interval: 60s
    rules:
      # DB å¯«å…¥é€Ÿç‡ç•°å¸¸ä½ï¼ˆä¿®æ­£ç‰ˆæœ¬ï¼šä½¿ç”¨åˆç†é–¾å€¼èˆ‡æ¸…æ™°å–®ä½ï¼‰
      - alert: LowDatabaseWriteRate
        expr: |
          (rate(collector_db_writes_total[5m]) < 0.01)
          and
          (rate(collector_db_writes_total[5m]) > 0)
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "è³‡æ–™åº«å¯«å…¥é€Ÿç‡ç•°å¸¸ä½"
          description: "éå» 5 åˆ†é˜å¹³å‡å¯«å…¥ï¼š{{ $value | printf \"%.4f\" }} rows/secï¼ˆé æœŸï¼šâ‰¥ 0.01ï¼‰ï¼Œè³‡æ–™æ”¶é›†å¯èƒ½åœæ»¯"

      # è³‡æ–™æ”¶é›†å®Œå…¨åœæ­¢ï¼ˆæ›´åš´é‡çš„æƒ…æ³ï¼‰
      - alert: DatabaseWriteStopped
        expr: |
          rate(collector_db_writes_total[10m]) == 0
        for: 10m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "è³‡æ–™åº«å¯«å…¥å®Œå…¨åœæ­¢"
          description: "éå» 10 åˆ†é˜æ²’æœ‰ä»»ä½•è³‡æ–™å¯«å…¥ï¼Œæ”¶é›†å™¨å¯èƒ½å·²åœæ­¢é‹è¡Œ"

  - name: system_alerts
    interval: 60s
    rules:
      # Redis é€£ç·šä¸­æ–·
      - alert: RedisDown
        expr: |
          up{job="redis"} == 0
        for: 3m
        labels:
          severity: critical
          component: redis
        annotations:
          summary: "Redis æœå‹™åœæ­¢é‹è¡Œ"
          description: "Redis å·²ç¶“åœæ­¢é‹è¡Œè¶…é 3 åˆ†é˜"

      # PostgreSQL é€£ç·šä¸­æ–·
      - alert: PostgreSQLDown
        expr: |
          up{job="postgres"} == 0
        for: 3m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "PostgreSQL æœå‹™åœæ­¢é‹è¡Œ"
          description: "PostgreSQL å·²ç¶“åœæ­¢é‹è¡Œè¶…é 3 åˆ†é˜"

  # åƒ¹æ ¼è®Šå‹•å‘Šè­¦
  - name: price_alerts
    interval: 30s
    rules:
      # åƒ¹æ ¼æ€¥åŠ‡ä¸Šæ¼²ï¼ˆ5 åˆ†é˜å…§æ¼²å¹…è¶…é 3%ï¼‰
      - alert: PriceSpike
        expr: |
          (
            (price_current{symbol=~"BTC.*|ETH.*"} - price_current{symbol=~"BTC.*|ETH.*"} offset 5m)
            / price_current{symbol=~"BTC.*|ETH.*"} offset 5m
          ) * 100 > 3
        for: 1m
        labels:
          severity: warning
          component: price_monitor
        annotations:
          summary: "{{ $labels.symbol }} åƒ¹æ ¼æ€¥åŠ‡ä¸Šæ¼²"
          description: "{{ $labels.symbol }} åœ¨ 5 åˆ†é˜å…§ä¸Šæ¼² {{ $value | printf \"%.2f%%\" }}ï¼ˆç•¶å‰åƒ¹æ ¼ï¼š{{ $labels.price }}ï¼‰"

      # åƒ¹æ ¼æ€¥åŠ‡ä¸‹è·Œï¼ˆ5 åˆ†é˜å…§è·Œå¹…è¶…é 3%ï¼‰
      - alert: PriceDrop
        expr: |
          (
            (price_current{symbol=~"BTC.*|ETH.*"} - price_current{symbol=~"BTC.*|ETH.*"} offset 5m)
            / price_current{symbol=~"BTC.*|ETH.*"} offset 5m
          ) * 100 < -3
        for: 1m
        labels:
          severity: warning
          component: price_monitor
        annotations:
          summary: "{{ $labels.symbol }} åƒ¹æ ¼æ€¥åŠ‡ä¸‹è·Œ"
          description: "{{ $labels.symbol }} åœ¨ 5 åˆ†é˜å…§ä¸‹è·Œ {{ $value | printf \"%.2f%%\" }}ï¼ˆç•¶å‰åƒ¹æ ¼ï¼š{{ $labels.price }}ï¼‰"

      # åƒ¹æ ¼æ¥µç«¯æ³¢å‹•ï¼ˆ5 åˆ†é˜å…§æ¼²è·Œå¹…è¶…é 5%ï¼‰
      - alert: ExtremePriceVolatility
        expr: |
          abs(
            (price_current{symbol=~"BTC.*|ETH.*"} - price_current{symbol=~"BTC.*|ETH.*"} offset 5m)
            / price_current{symbol=~"BTC.*|ETH.*"} offset 5m
          ) * 100 > 5
        for: 30s
        labels:
          severity: critical
          component: price_monitor
        annotations:
          summary: "{{ $labels.symbol }} åƒ¹æ ¼æ¥µç«¯æ³¢å‹•"
          description: "{{ $labels.symbol }} åœ¨ 5 åˆ†é˜å…§æ³¢å‹• {{ $value | printf \"%.2f%%\" }}ï¼ˆç•¶å‰åƒ¹æ ¼ï¼š{{ $labels.price }}ï¼‰âš ï¸ éœ€è¦ç«‹å³é—œæ³¨ï¼"

      # åƒ¹æ ¼ç•°å¸¸åœæ»¯ï¼ˆ10 åˆ†é˜å…§åƒ¹æ ¼ç„¡è®ŠåŒ–ï¼‰
      - alert: PriceStagnant
        expr: |
          (
            price_current{symbol=~"BTC.*|ETH.*"} == price_current{symbol=~"BTC.*|ETH.*"} offset 10m
          )
        for: 5m
        labels:
          severity: warning
          component: price_monitor
        annotations:
          summary: "{{ $labels.symbol }} åƒ¹æ ¼ç•°å¸¸åœæ»¯"
          description: "{{ $labels.symbol }} åƒ¹æ ¼åœ¨éå» 10 åˆ†é˜å…§æ²’æœ‰è®ŠåŒ–ï¼ˆç•¶å‰åƒ¹æ ¼ï¼š{{ $labels.price }}ï¼‰ï¼Œå¯èƒ½æ˜¯æ•¸æ“šæºå•é¡Œ"

  # MAD ç•°å¸¸æª¢æ¸¬å‘Šè­¦
  - name: mad_anomaly_alerts
    interval: 30s
    rules:
      # MAD æª¢æ¸¬åˆ°ç•°å¸¸ï¼ˆè­¦å‘Šç´šåˆ¥ï¼‰
      - alert: MADAnomalyDetected
        expr: |
          mad_anomaly_score{symbol=~"BTC.*|ETH.*"} > 3
        for: 1m
        labels:
          severity: warning
          component: mad_detector
        annotations:
          summary: "MAD æª¢æ¸¬åˆ° {{ $labels.symbol }} ç•°å¸¸"
          description: "{{ $labels.symbol }} ç•°å¸¸åˆ†æ•¸: {{ $value | humanize }}ï¼ˆé–¾å€¼: 3.0ï¼‰ï¼Œç•¶å‰åƒ¹æ ¼åé›¢ä¸­ä½æ•¸è¼ƒå¤§"

      # MAD æª¢æ¸¬åˆ°åš´é‡ç•°å¸¸ï¼ˆåš´é‡ç´šåˆ¥ï¼‰
      - alert: MADSevereAnomaly
        expr: |
          mad_anomaly_score{symbol=~"BTC.*|ETH.*"} > 5
        for: 30s
        labels:
          severity: critical
          component: mad_detector
        annotations:
          summary: "MAD æª¢æ¸¬åˆ° {{ $labels.symbol }} åš´é‡ç•°å¸¸ ğŸš¨"
          description: "{{ $labels.symbol }} ç•°å¸¸åˆ†æ•¸: {{ $value | humanize }}ï¼ˆé–¾å€¼: 5.0ï¼‰âš ï¸ åƒ¹æ ¼åš´é‡åé›¢æ­£å¸¸ç¯„åœï¼Œè«‹ç«‹å³æª¢æŸ¥ï¼"

      # MAD ç•°å¸¸æª¢æ¸¬ç‡éé«˜
      - alert: HighAnomalyRate
        expr: |
          (
            rate(mad_anomaly_detected_total{severity="warning"}[1h]) > 0.1
          )
        for: 5m
        labels:
          severity: warning
          component: mad_detector
        annotations:
          summary: "{{ $labels.symbol }} ç•°å¸¸æª¢æ¸¬ç‡éé«˜"
          description: "{{ $labels.symbol }} éå» 1 å°æ™‚ç•°å¸¸æª¢æ¸¬ç‡: {{ $value | printf \"%.2f%%\" }}ï¼ˆè¶…é 10%ï¼‰ï¼Œå¸‚å ´å¯èƒ½è™•æ–¼é«˜æ³¢å‹•ç‹€æ…‹"

      # MAD æª¢æ¸¬æœå‹™åœæ­¢é‹è¡Œ
      - alert: MADDetectorDown
        expr: |
          up{job="mad-detector"} == 0
        for: 3m
        labels:
          severity: critical
          component: mad_detector
        annotations:
          summary: "MAD ç•°å¸¸æª¢æ¸¬æœå‹™åœæ­¢é‹è¡Œ"
          description: "MAD Detector å·²ç¶“åœæ­¢é‹è¡Œè¶…é 3 åˆ†é˜ï¼Œç•°å¸¸æª¢æ¸¬åŠŸèƒ½ä¸å¯ç”¨"

      # MAD æª¢æ¸¬å»¶é²éé«˜
      - alert: MADDetectionHighLatency
        expr: |
          mad_detection_latency_seconds{quantile="0.99"} > 5
        for: 5m
        labels:
          severity: warning
          component: mad_detector
        annotations:
          summary: "MAD ç•°å¸¸æª¢æ¸¬å»¶é²éé«˜"
          description: "{{ $labels.symbol }} çš„ 99 åˆ†ä½æª¢æ¸¬å»¶é²: {{ $value | printf \"%.2f\" }}sï¼ˆé æœŸ: < 5sï¼‰ï¼Œå¯èƒ½å½±éŸ¿å³æ™‚ç›£æ§"
