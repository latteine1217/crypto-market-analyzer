# TimescaleDB è³‡æ–™ä¿ç•™ç­–ç•¥å‘Šè­¦è¦å‰‡

groups:
  - name: timescaledb_retention_alerts
    interval: 60s
    rules:
      # ========== é€£çºŒèšåˆå‘Šè­¦ ==========
      
      # Alert 1: é€£çºŒèšåˆè¦–åœ–è³‡æ–™éæ™‚ï¼ˆæ ¹æ“š end_offset å‹•æ…‹åˆ¤æ–·ï¼‰
      # è¨»ï¼šä¸åŒè¦–åœ–æœ‰ä¸åŒçš„ end_offsetï¼ˆ5m-2hï¼‰ï¼Œè³‡æ–™å»¶é²æ‡‰åœ¨åˆç†ç¯„åœå…§
      - alert: ContinuousAggregateStale
        expr: |
          (
            # ohlcv_5m: end_offset 5mï¼Œå®¹å¿å»¶é² 2h
            (time() - timescaledb_continuous_aggregate_newest_data_timestamp{view_name="ohlcv_5m"}) > 7200
          ) or (
            # ohlcv_15m: end_offset 15mï¼Œå®¹å¿å»¶é² 2h
            (time() - timescaledb_continuous_aggregate_newest_data_timestamp{view_name="ohlcv_15m"}) > 7200
          ) or (
            # ohlcv_1h: end_offset 1hï¼Œå®¹å¿å»¶é² 6h
            (time() - timescaledb_continuous_aggregate_newest_data_timestamp{view_name="ohlcv_1h"}) > 21600
          ) or (
            # ohlcv_1d: end_offset 2hï¼Œå®¹å¿å»¶é² 2 å¤©
            (time() - timescaledb_continuous_aggregate_newest_data_timestamp{view_name="ohlcv_1d"}) > 172800
          )
        for: 10m
        labels:
          severity: warning
          component: timescaledb
          category: continuous_aggregate
        annotations:
          summary: "é€£çºŒèšåˆè¦–åœ– {{ $labels.view_name }} è³‡æ–™éæ™‚"
          description: |
            è¦–åœ– {{ $labels.view_name }} æœ€æ–°è³‡æ–™æ™‚é–“ï¼š{{ $value | humanizeDuration }} å‰
            é€™å¯èƒ½è¡¨ç¤ºè³‡æ–™æ”¶é›†ä¸­æ–·æˆ–æºè³‡æ–™ä¸è¶³
      
      # Alert 2: é€£çºŒèšåˆè¦–åœ–è¨˜éŒ„æ•¸ç•°å¸¸å°‘
      - alert: ContinuousAggregateRecordCountLow
        expr: |
          timescaledb_continuous_aggregate_record_count < 100
          and
          timescaledb_continuous_aggregate_record_count > 0
        for: 30m
        labels:
          severity: warning
          component: timescaledb
          category: continuous_aggregate
        annotations:
          summary: "é€£çºŒèšåˆè¦–åœ– {{ $labels.view_name }} è¨˜éŒ„æ•¸ç•°å¸¸å°‘"
          description: |
            è¦–åœ– {{ $labels.view_name }} åªæœ‰ {{ $value }} ç­†è¨˜éŒ„
            é€™å¯èƒ½è¡¨ç¤ºè³‡æ–™æ”¶é›†å•é¡Œæˆ–èšåˆé…ç½®éŒ¯èª¤
      
      # Alert 3: èšåˆè¦–åœ–è³‡æ–™éæ™‚ï¼ˆæ ¹æ“šè¦–åœ–ç‰¹æ€§è¨­å®šä¸åŒé–¾å€¼ï¼‰
      # è¨»ï¼šèˆ‡ Alert 1 é¡ä¼¼ï¼Œä½†ä½¿ç”¨ newest_data_timestamp è€Œé last_update_timestamp
      - alert: ContinuousAggregateDataOutdated
        expr: |
          (
            # ohlcv_5m: å®¹å¿ 2å°æ™‚ å»¶é²
            (time() - timescaledb_continuous_aggregate_newest_data_timestamp{view_name="ohlcv_5m"}) > 7200
          ) or (
            # ohlcv_15m: å®¹å¿ 2å°æ™‚ å»¶é²
            (time() - timescaledb_continuous_aggregate_newest_data_timestamp{view_name="ohlcv_15m"}) > 7200
          ) or (
            # ohlcv_1h: å®¹å¿ 6å°æ™‚ å»¶é²
            (time() - timescaledb_continuous_aggregate_newest_data_timestamp{view_name="ohlcv_1h"}) > 21600
          ) or (
            # ohlcv_1d: å®¹å¿ 2å¤© å»¶é²
            (time() - timescaledb_continuous_aggregate_newest_data_timestamp{view_name="ohlcv_1d"}) > 172800
          )
        for: 15m
        labels:
          severity: warning
          component: timescaledb
          category: continuous_aggregate
        annotations:
          summary: "é€£çºŒèšåˆè¦–åœ– {{ $labels.view_name }} è³‡æ–™éæ™‚"
          description: |
            è¦–åœ– {{ $labels.view_name }} æœ€æ–°è³‡æ–™æ™‚é–“ï¼š{{ $value | humanizeDuration }} å‰
            è³‡æ–™æ”¶é›†å¯èƒ½å·²ä¸­æ–·æˆ–èšåˆéˆä¸Šæ¸¸è³‡æ–™ä¸è¶³
      
      # ========== TimescaleDB Jobs å‘Šè­¦ ==========
      
      # Alert 4: TimescaleDB Job è¢«ç¦ç”¨
      - alert: TimescaleDBJobDisabled
        expr: |
          timescaledb_job_enabled == 0
        for: 5m
        labels:
          severity: warning
          component: timescaledb
          category: job
        annotations:
          summary: "TimescaleDB Job {{ $labels.job_id }} è¢«ç¦ç”¨"
          description: |
            Job {{ $labels.job_id }} ({{ $labels.job_type }}) å·²è¢«ç¦ç”¨
            Hypertable: {{ $labels.hypertable_name }}
            è«‹æª¢æŸ¥æ˜¯å¦ç‚ºé æœŸè¡Œç‚º
      
      # Alert 5: TimescaleDB Job é€¾æœŸæœªåŸ·è¡Œï¼ˆå·²è¶…éä¸‹æ¬¡æ’ç¨‹æ™‚é–“ 2 å°æ™‚ï¼‰
      # è¨»ï¼šæª¢æŸ¥ job æ˜¯å¦çœŸçš„é€¾æœŸï¼Œè€Œéç°¡å–®æ¯”è¼ƒæœ€å¾ŒåŸ·è¡Œæ™‚é–“
      - alert: TimescaleDBJobNotRunning
        expr: |
          (time() - timescaledb_job_next_start_timestamp) > 7200
          and
          timescaledb_job_enabled == 1
        for: 10m
        labels:
          severity: critical
          component: timescaledb
          category: job
        annotations:
          summary: "TimescaleDB Job {{ $labels.job_id }} å·²é€¾æœŸè¶…é 2 å°æ™‚æœªåŸ·è¡Œ"
          description: |
            Job {{ $labels.job_id }} ({{ $labels.job_type }}) æ‡‰åŸ·è¡Œæ™‚é–“ï¼š{{ $labels.next_start | humanizeTimestamp }}
            ç›®å‰å·²é€¾æœŸï¼š{{ $value | humanizeDuration }}
            Hypertable: {{ $labels.hypertable_name }}
            Job å¯èƒ½å·²å¤±æ•—æˆ–æ’ç¨‹ç•°å¸¸ï¼Œè«‹ç«‹å³æª¢æŸ¥ï¼
      
      # Alert 6: TimescaleDB Job æœ€å¾ŒåŸ·è¡Œå¤±æ•—
      - alert: TimescaleDBJobLastRunFailed
        expr: |
          (timescaledb_job_last_run_timestamp - timescaledb_job_last_success_timestamp) > 60
          and
          timescaledb_job_enabled == 1
        for: 5m
        labels:
          severity: critical
          component: timescaledb
          category: job
        annotations:
          summary: "TimescaleDB Job {{ $labels.job_id }} æœ€å¾ŒåŸ·è¡Œå¤±æ•—"
          description: |
            Job {{ $labels.job_id }} ({{ $labels.job_type }}) æœ€å¾ŒåŸ·è¡Œå¤±æ•—
            Hypertable: {{ $labels.hypertable_name }}
            æœ€å¾ŒæˆåŠŸï¼š{{ $labels.last_success_timestamp | humanizeTimestamp }}
            æœ€å¾ŒåŸ·è¡Œï¼š{{ $labels.last_run_timestamp | humanizeTimestamp }}
      
      # Alert 7: TimescaleDB Job åŸ·è¡Œæ™‚é–“éé•·
      - alert: TimescaleDBJobSlowExecution
        expr: |
          timescaledb_job_total_duration_seconds > 600
        for: 5m
        labels:
          severity: warning
          component: timescaledb
          category: job
        annotations:
          summary: "TimescaleDB Job {{ $labels.job_id }} åŸ·è¡Œæ™‚é–“éé•·"
          description: |
            Job {{ $labels.job_id }} ({{ $labels.job_type }}) åŸ·è¡Œæ™‚é•·ï¼š{{ $value | humanizeDuration }}
            Hypertable: {{ $labels.hypertable_name }}
            å¯èƒ½éœ€è¦å„ªåŒ–æˆ–æª¢æŸ¥è³‡æ–™é‡

      # ========== è³‡æ–™ä¿ç•™ç­–ç•¥å‘Šè­¦ ==========
      
      # Alert 8: å¯¦éš›ä¿ç•™æœŸé–“è¶…éé æœŸå¤ªå¤šï¼ˆè¶…é 20%ï¼‰
      - alert: DataRetentionDeviation
        expr: |
          timescaledb_data_retention_deviation_days > 
            (timescaledb_data_expected_retention_days * 0.2)
          and
          timescaledb_data_expected_retention_days > 0
        for: 1h
        labels:
          severity: warning
          component: timescaledb
          category: retention
        annotations:
          summary: "{{ $labels.layer }} è³‡æ–™ä¿ç•™æœŸé–“åå·®éå¤§"
          description: |
            å±¤ç´šï¼š{{ $labels.layer }}
            å¯¦éš›ä¿ç•™ï¼š{{ $labels.actual_retention_days }} å¤©
            é æœŸä¿ç•™ï¼š{{ $labels.expected_retention_days }} å¤©
            åå·®ï¼š{{ $value }} å¤©
            ä¿ç•™ç­–ç•¥å¯èƒ½æœªæ­£å¸¸åŸ·è¡Œ
      
      # Alert 9: è³‡æ–™ä¿ç•™æœŸé–“åš´é‡è¶…æ¨™ï¼ˆè¶…é 50%ï¼‰
      - alert: DataRetentionSevereDeviation
        expr: |
          timescaledb_data_retention_deviation_days > 
            (timescaledb_data_expected_retention_days * 0.5)
          and
          timescaledb_data_expected_retention_days > 0
        for: 30m
        labels:
          severity: critical
          component: timescaledb
          category: retention
        annotations:
          summary: "{{ $labels.layer }} è³‡æ–™ä¿ç•™æœŸé–“åš´é‡è¶…æ¨™ ğŸš¨"
          description: |
            å±¤ç´šï¼š{{ $labels.layer }}
            å¯¦éš›ä¿ç•™ï¼š{{ $labels.actual_retention_days }} å¤©
            é æœŸä¿ç•™ï¼š{{ $labels.expected_retention_days }} å¤©
            åå·®ï¼š{{ $value }} å¤©
            âš ï¸ ä¿ç•™ç­–ç•¥å¯èƒ½å·²å¤±æ•ˆï¼Œè«‹ç«‹å³æª¢æŸ¥ï¼
      
      # Alert 10: è³‡æ–™å±¤è¨˜éŒ„æ•¸ç•°å¸¸å°‘ï¼ˆæ ¹æ“šä¸åŒè¦–åœ–è¨­å®šåˆç†é–¾å€¼ï¼‰
      # è¨»ï¼šä¸åŒæ™‚é–“ç²’åº¦çš„è¦–åœ–æœ‰ä¸åŒçš„åˆç†è¨˜éŒ„æ•¸ç¯„åœ
      - alert: DataLayerRecordCountLow
        expr: |
          (
            # ohlcv_5m: 5åˆ†é˜ç²’åº¦ï¼Œ1å¤© = 288ç­†ï¼Œåˆç†æœ€å°å€¼ 100ç­†ï¼ˆç´„8å°æ™‚ï¼‰
            timescaledb_data_total_records{layer="ohlcv_5m"} < 100
            and
            timescaledb_data_total_records{layer="ohlcv_5m"} > 0
          ) or (
            # ohlcv_15m: 15åˆ†é˜ç²’åº¦ï¼Œ1å¤© = 96ç­†ï¼Œåˆç†æœ€å°å€¼ 50ç­†ï¼ˆç´„12å°æ™‚ï¼‰
            timescaledb_data_total_records{layer="ohlcv_15m"} < 50
            and
            timescaledb_data_total_records{layer="ohlcv_15m"} > 0
          ) or (
            # ohlcv_1h: 1å°æ™‚ç²’åº¦ï¼Œ1å¤© = 24ç­†ï¼Œåˆç†æœ€å°å€¼ 24ç­†ï¼ˆ1å¤©ï¼‰
            timescaledb_data_total_records{layer="ohlcv_1h"} < 24
            and
            timescaledb_data_total_records{layer="ohlcv_1h"} > 0
          ) or (
            # ohlcv_1d: æ—¥ç·šç²’åº¦ï¼Œåˆç†æœ€å°å€¼ 3ç­†ï¼ˆ3å¤©ï¼‰
            timescaledb_data_total_records{layer="ohlcv_1d"} < 3
            and
            timescaledb_data_total_records{layer="ohlcv_1d"} > 0
          ) or (
            # raw_1m: 1åˆ†é˜åŸå§‹è³‡æ–™ï¼Œ1å¤© = 1440ç­†ï¼Œåˆç†æœ€å°å€¼ 500ç­†ï¼ˆç´„8å°æ™‚ï¼‰
            timescaledb_data_total_records{layer="raw_1m"} < 500
            and
            timescaledb_data_total_records{layer="raw_1m"} > 0
          )
        for: 1h
        labels:
          severity: warning
          component: timescaledb
          category: retention
        annotations:
          summary: "{{ $labels.layer }} è³‡æ–™è¨˜éŒ„æ•¸ç•°å¸¸å°‘"
          description: |
            å±¤ç´šï¼š{{ $labels.layer }}
            è¨˜éŒ„æ•¸ï¼š{{ $value }}
            å¯èƒ½æ˜¯è³‡æ–™æ”¶é›†å•é¡Œæˆ–è³‡æ–™è¢«éåº¦æ¸…ç†
            å»ºè­°æª¢æŸ¥è³‡æ–™æ”¶é›†ç‹€æ…‹å’Œä¿ç•™ç­–ç•¥é…ç½®
      
      # ========== è³‡æ–™å®Œæ•´æ€§å‘Šè­¦ ==========
      
      # Alert 11: èšåˆå£“ç¸®æ¯”ç•°å¸¸
      - alert: AggregateCompressionRatioAbnormal
        expr: |
          abs(timescaledb_aggregate_compression_ratio - 5) > 1.5
        for: 30m
        labels:
          severity: warning
          component: timescaledb
          category: data_integrity
        annotations:
          summary: "èšåˆå£“ç¸®æ¯”ç•°å¸¸"
          description: |
            {{ $labels.source_layer }} åˆ° {{ $labels.target_layer }} å£“ç¸®æ¯”ï¼š{{ $value }}
            é æœŸç´„ç‚º 5:1
            å¯èƒ½è¡¨ç¤ºè³‡æ–™ç¼ºå¤±æˆ–èšåˆé…ç½®å•é¡Œ
      
      # ========== å„²å­˜ç©ºé–“å‘Šè­¦ ==========
      
      # Alert 12: è¡¨ç©ºé–“ä½¿ç”¨é‡éå¤§ï¼ˆè¶…é 50GBï¼‰
      - alert: TableSizeExcessive
        expr: |
          timescaledb_table_size_bytes > 50 * 1024 * 1024 * 1024
        for: 1h
        labels:
          severity: warning
          component: timescaledb
          category: storage
        annotations:
          summary: "è¡¨ {{ $labels.table_name }} ç©ºé–“ä½¿ç”¨é‡éå¤§"
          description: |
            è¡¨ï¼š{{ $labels.table_name }}
            å¤§å°ï¼š{{ $value }} bytes (> 50GB)
            å»ºè­°æª¢æŸ¥è³‡æ–™ä¿ç•™ç­–ç•¥æ˜¯å¦æ­£å¸¸é‹è¡Œ
      
      # Alert 13: ç´¢å¼•ç©ºé–“ä½¿ç”¨é‡éå¤§ï¼ˆçµ•å°å¤§å°è¶…é 5GBï¼‰
      # è¨»ï¼šTimescaleDB hypertable ä¸»è¡¨çš„ table_size ç‚º 0ï¼ˆè³‡æ–™å­˜åœ¨ chunksï¼‰ï¼Œ
      #     å› æ­¤åªæª¢æŸ¥ç´¢å¼•çµ•å°å¤§å°ï¼Œä¸¦æ’é™¤ hypertable ä¸»è¡¨ï¼ˆtable_size = 0ï¼‰
      - alert: IndexSizeExcessive
        expr: |
          timescaledb_index_size_bytes > 5 * 1024 * 1024 * 1024
          and
          timescaledb_table_size_bytes > 0
        for: 1h
        labels:
          severity: warning
          component: timescaledb
          category: storage
        annotations:
          summary: "è¡¨ {{ $labels.table_name }} ç´¢å¼•ç©ºé–“ä½¿ç”¨é‡éå¤§"
          description: |
            è¡¨ï¼š{{ $labels.table_name }}
            ç´¢å¼•å¤§å°ï¼š{{ $value }} bytes (> 5GB)
            å»ºè­°æª¢æŸ¥ç´¢å¼•æ˜¯å¦éœ€è¦å„ªåŒ–æˆ–é‡å»º
      
      # ========== ç›£æ§æœå‹™æœ¬èº«çš„å‘Šè­¦ ==========
      
      # Alert 14: ä¿ç•™ç›£æ§æœå‹™è¶…é 10 åˆ†é˜æœªæª¢æŸ¥
      - alert: RetentionMonitorNotChecking
        expr: |
          (time() - timescaledb_retention_monitor_last_check_timestamp) > 600
        for: 5m
        labels:
          severity: critical
          component: retention_monitor
          category: service
        annotations:
          summary: "è³‡æ–™ä¿ç•™ç›£æ§æœå‹™è¶…é 10 åˆ†é˜æœªåŸ·è¡Œæª¢æŸ¥"
          description: |
            æœ€å¾Œæª¢æŸ¥æ™‚é–“ï¼š{{ $value | humanizeDuration }} å‰
            ç›£æ§æœå‹™å¯èƒ½å·²åœæ­¢é‹è¡Œ
      
      # Alert 15: ä¿ç•™ç›£æ§æª¢æŸ¥åŸ·è¡Œæ™‚é–“éé•·
      - alert: RetentionMonitorSlowCheck
        expr: |
          timescaledb_retention_monitor_check_duration_seconds > 60
        for: 5m
        labels:
          severity: warning
          component: retention_monitor
          category: performance
        annotations:
          summary: "è³‡æ–™ä¿ç•™ç›£æ§æª¢æŸ¥åŸ·è¡Œæ™‚é–“éé•·"
          description: |
            æª¢æŸ¥åŸ·è¡Œæ™‚é•·ï¼š{{ $value }}ç§’
            å¯èƒ½è¡¨ç¤ºè³‡æ–™åº«è² è¼‰éé«˜æˆ–æŸ¥è©¢æ•ˆç‡å•é¡Œ
      
      # ========== è³‡æ–™åº«é€£æ¥å¥åº·å‘Šè­¦ (Migration 010) ==========
      
      # Alert 16: Idle in transaction é€£æ¥æ•¸éå¤š
      - alert: IdleInTransactionConnectionsHigh
        expr: |
          timescaledb_idle_in_transaction_connections > 5
        for: 5m
        labels:
          severity: warning
          component: timescaledb
          category: connection
        annotations:
          summary: "Idle in transaction é€£æ¥æ•¸éå¤š"
          description: |
            ç•¶å‰ idle in transaction é€£æ¥æ•¸ï¼š{{ $value }}
            éå¤šçš„ idle in transaction é€£æ¥å¯èƒ½é˜»å¡ retention jobs
            å»ºè­°æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼é€£æ¥ç®¡ç†é‚è¼¯
      
      # Alert 17: é•·æ™‚é–“ idle in transaction é€£æ¥ï¼ˆè¶…é 5 åˆ†é˜ï¼‰
      - alert: LongIdleInTransactionConnection
        expr: |
          timescaledb_idle_in_transaction_max_duration_seconds > 300
        for: 2m
        labels:
          severity: warning
          component: timescaledb
          category: connection
        annotations:
          summary: "æª¢æ¸¬åˆ°é•·æ™‚é–“ idle in transaction é€£æ¥"
          description: |
            æœ€é•· idle in transaction æŒçºŒæ™‚é–“ï¼š{{ $value | humanizeDuration }}
            é€™å¯èƒ½é˜»å¡ retention jobs çš„åŸ·è¡Œ
            é€£æ¥å°‡åœ¨ 10 åˆ†é˜æ™‚è‡ªå‹•çµ‚æ­¢ï¼ˆidle_in_transaction_session_timeoutï¼‰
      
      # Alert 18: æ¥µé•·æ™‚é–“ idle in transaction é€£æ¥ï¼ˆè¶…é 8 åˆ†é˜ï¼Œæ¥è¿‘è¶…æ™‚ï¼‰
      - alert: CriticalIdleInTransactionConnection
        expr: |
          timescaledb_idle_in_transaction_max_duration_seconds > 480
        for: 1m
        labels:
          severity: critical
          component: timescaledb
          category: connection
        annotations:
          summary: "æª¢æ¸¬åˆ°æ¥µé•·æ™‚é–“ idle in transaction é€£æ¥ ğŸš¨"
          description: |
            æœ€é•· idle in transaction æŒçºŒæ™‚é–“ï¼š{{ $value | humanizeDuration }}
            å·²æ¥è¿‘ 10 åˆ†é˜è¶…æ™‚é–¾å€¼ï¼Œå°‡è‡ªå‹•çµ‚æ­¢
            è«‹æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼æ˜¯å¦æœªæ­£ç¢ºæäº¤/å›æ»¾äº‹å‹™

