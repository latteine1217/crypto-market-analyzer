# TimescaleDB è³‡æ–™ä¿ç•™ç­–ç•¥å‘Šè­¦è¦å‰‡

groups:
  - name: timescaledb_retention_alerts
    interval: 60s
    rules:
      # ========== é€£çºŒèšåˆå‘Šè­¦ ==========
      
      # Alert 1: é€£çºŒèšåˆè¦–åœ–è¶…é 2 å°æ™‚æœªæ›´æ–°
      - alert: ContinuousAggregateStale
        expr: |
          (time() - timescaledb_continuous_aggregate_last_update_timestamp) > 7200
        for: 10m
        labels:
          severity: warning
          component: timescaledb
          category: continuous_aggregate
        annotations:
          summary: "é€£çºŒèšåˆè¦–åœ– {{ $labels.view_name }} è¶…é 2 å°æ™‚æœªæ›´æ–°"
          description: |
            è¦–åœ– {{ $labels.view_name }} æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š{{ $value | humanizeDuration }} å‰
            é€™å¯èƒ½è¡¨ç¤ºèšåˆ job åŸ·è¡Œå¤±æ•—æˆ–è³‡æ–™æ”¶é›†ä¸­æ–·
      
      # Alert 2: é€£çºŒèšåˆè¦–åœ–è¨˜éŒ„æ•¸ç•°å¸¸å°‘
      - alert: ContinuousAggregateRecordCountLow
        expr: |
          timescaledb_continuous_aggregate_record_count < 100
          and
          timescaledb_continuous_aggregate_record_count > 0
        for: 30m
        labels:
          severity: warning
          component: timescaledb
          category: continuous_aggregate
        annotations:
          summary: "é€£çºŒèšåˆè¦–åœ– {{ $labels.view_name }} è¨˜éŒ„æ•¸ç•°å¸¸å°‘"
          description: |
            è¦–åœ– {{ $labels.view_name }} åªæœ‰ {{ $value }} ç­†è¨˜éŒ„
            é€™å¯èƒ½è¡¨ç¤ºè³‡æ–™æ”¶é›†å•é¡Œæˆ–èšåˆé…ç½®éŒ¯èª¤
      
      # Alert 3: èšåˆè¦–åœ–è³‡æ–™éæ™‚ï¼ˆæœ€æ–°è³‡æ–™è¶…é 6 å°æ™‚ï¼‰
      - alert: ContinuousAggregateDataOutdated
        expr: |
          (time() - timescaledb_continuous_aggregate_newest_data_timestamp) > 21600
        for: 15m
        labels:
          severity: warning
          component: timescaledb
          category: continuous_aggregate
        annotations:
          summary: "é€£çºŒèšåˆè¦–åœ– {{ $labels.view_name }} è³‡æ–™éæ™‚"
          description: |
            è¦–åœ– {{ $labels.view_name }} æœ€æ–°è³‡æ–™æ™‚é–“ï¼š{{ $value | humanizeDuration }} å‰
            è³‡æ–™æ”¶é›†å¯èƒ½å·²ä¸­æ–·
      
      # ========== TimescaleDB Jobs å‘Šè­¦ ==========
      
      # Alert 4: TimescaleDB Job è¢«ç¦ç”¨
      - alert: TimescaleDBJobDisabled
        expr: |
          timescaledb_job_enabled == 0
        for: 5m
        labels:
          severity: warning
          component: timescaledb
          category: job
        annotations:
          summary: "TimescaleDB Job {{ $labels.job_id }} è¢«ç¦ç”¨"
          description: |
            Job {{ $labels.job_id }} ({{ $labels.job_type }}) å·²è¢«ç¦ç”¨
            Hypertable: {{ $labels.hypertable_name }}
            è«‹æª¢æŸ¥æ˜¯å¦ç‚ºé æœŸè¡Œç‚º
      
      # Alert 5: TimescaleDB Job è¶…é 2 å°æ™‚æœªåŸ·è¡Œ
      - alert: TimescaleDBJobNotRunning
        expr: |
          (time() - timescaledb_job_last_run_timestamp) > 7200
          and
          timescaledb_job_enabled == 1
        for: 10m
        labels:
          severity: critical
          component: timescaledb
          category: job
        annotations:
          summary: "TimescaleDB Job {{ $labels.job_id }} è¶…é 2 å°æ™‚æœªåŸ·è¡Œ"
          description: |
            Job {{ $labels.job_id }} ({{ $labels.job_type }}) æœ€å¾ŒåŸ·è¡Œæ™‚é–“ï¼š{{ $value | humanizeDuration }} å‰
            Hypertable: {{ $labels.hypertable_name }}
            Job å¯èƒ½å·²å¤±æ•—æˆ–æ’ç¨‹ç•°å¸¸
      
      # Alert 6: TimescaleDB Job æœ€å¾ŒåŸ·è¡Œå¤±æ•—
      - alert: TimescaleDBJobLastRunFailed
        expr: |
          (timescaledb_job_last_run_timestamp - timescaledb_job_last_success_timestamp) > 60
          and
          timescaledb_job_enabled == 1
        for: 5m
        labels:
          severity: critical
          component: timescaledb
          category: job
        annotations:
          summary: "TimescaleDB Job {{ $labels.job_id }} æœ€å¾ŒåŸ·è¡Œå¤±æ•—"
          description: |
            Job {{ $labels.job_id }} ({{ $labels.job_type }}) æœ€å¾ŒåŸ·è¡Œå¤±æ•—
            Hypertable: {{ $labels.hypertable_name }}
            æœ€å¾ŒæˆåŠŸï¼š{{ $labels.last_success_timestamp | humanizeTimestamp }}
            æœ€å¾ŒåŸ·è¡Œï¼š{{ $labels.last_run_timestamp | humanizeTimestamp }}
      
      # Alert 7: TimescaleDB Job åŸ·è¡Œæ™‚é–“éé•·
      - alert: TimescaleDBJobSlowExecution
        expr: |
          timescaledb_job_total_duration_seconds > 600
        for: 5m
        labels:
          severity: warning
          component: timescaledb
          category: job
        annotations:
          summary: "TimescaleDB Job {{ $labels.job_id }} åŸ·è¡Œæ™‚é–“éé•·"
          description: |
            Job {{ $labels.job_id }} ({{ $labels.job_type }}) åŸ·è¡Œæ™‚é•·ï¼š{{ $value | humanizeDuration }}
            Hypertable: {{ $labels.hypertable_name }}
            å¯èƒ½éœ€è¦å„ªåŒ–æˆ–æª¢æŸ¥è³‡æ–™é‡

      # ========== è³‡æ–™ä¿ç•™ç­–ç•¥å‘Šè­¦ ==========
      
      # Alert 8: å¯¦éš›ä¿ç•™æœŸé–“è¶…éé æœŸå¤ªå¤šï¼ˆè¶…é 20%ï¼‰
      - alert: DataRetentionDeviation
        expr: |
          timescaledb_data_retention_deviation_days > 
            (timescaledb_data_expected_retention_days * 0.2)
          and
          timescaledb_data_expected_retention_days > 0
        for: 1h
        labels:
          severity: warning
          component: timescaledb
          category: retention
        annotations:
          summary: "{{ $labels.layer }} è³‡æ–™ä¿ç•™æœŸé–“åå·®éå¤§"
          description: |
            å±¤ç´šï¼š{{ $labels.layer }}
            å¯¦éš›ä¿ç•™ï¼š{{ $labels.actual_retention_days }} å¤©
            é æœŸä¿ç•™ï¼š{{ $labels.expected_retention_days }} å¤©
            åå·®ï¼š{{ $value }} å¤©
            ä¿ç•™ç­–ç•¥å¯èƒ½æœªæ­£å¸¸åŸ·è¡Œ
      
      # Alert 9: è³‡æ–™ä¿ç•™æœŸé–“åš´é‡è¶…æ¨™ï¼ˆè¶…é 50%ï¼‰
      - alert: DataRetentionSevereDeviation
        expr: |
          timescaledb_data_retention_deviation_days > 
            (timescaledb_data_expected_retention_days * 0.5)
          and
          timescaledb_data_expected_retention_days > 0
        for: 30m
        labels:
          severity: critical
          component: timescaledb
          category: retention
        annotations:
          summary: "{{ $labels.layer }} è³‡æ–™ä¿ç•™æœŸé–“åš´é‡è¶…æ¨™ ğŸš¨"
          description: |
            å±¤ç´šï¼š{{ $labels.layer }}
            å¯¦éš›ä¿ç•™ï¼š{{ $labels.actual_retention_days }} å¤©
            é æœŸä¿ç•™ï¼š{{ $labels.expected_retention_days }} å¤©
            åå·®ï¼š{{ $value }} å¤©
            âš ï¸ ä¿ç•™ç­–ç•¥å¯èƒ½å·²å¤±æ•ˆï¼Œè«‹ç«‹å³æª¢æŸ¥ï¼
      
      # Alert 10: è³‡æ–™å±¤è¨˜éŒ„æ•¸ç•°å¸¸å°‘
      - alert: DataLayerRecordCountLow
        expr: |
          timescaledb_data_total_records < 1000
          and
          timescaledb_data_total_records > 0
        for: 1h
        labels:
          severity: warning
          component: timescaledb
          category: retention
        annotations:
          summary: "{{ $labels.layer }} è³‡æ–™è¨˜éŒ„æ•¸ç•°å¸¸å°‘"
          description: |
            å±¤ç´šï¼š{{ $labels.layer }}
            è¨˜éŒ„æ•¸ï¼š{{ $value }}
            å¯èƒ½æ˜¯è³‡æ–™æ”¶é›†å•é¡Œæˆ–è³‡æ–™è¢«éåº¦æ¸…ç†
      
      # ========== è³‡æ–™å®Œæ•´æ€§å‘Šè­¦ ==========
      
      # Alert 11: èšåˆå£“ç¸®æ¯”ç•°å¸¸
      - alert: AggregateCompressionRatioAbnormal
        expr: |
          abs(timescaledb_aggregate_compression_ratio - 5) > 1.5
        for: 30m
        labels:
          severity: warning
          component: timescaledb
          category: data_integrity
        annotations:
          summary: "èšåˆå£“ç¸®æ¯”ç•°å¸¸"
          description: |
            {{ $labels.source_layer }} åˆ° {{ $labels.target_layer }} å£“ç¸®æ¯”ï¼š{{ $value }}
            é æœŸç´„ç‚º 5:1
            å¯èƒ½è¡¨ç¤ºè³‡æ–™ç¼ºå¤±æˆ–èšåˆé…ç½®å•é¡Œ
      
      # ========== å„²å­˜ç©ºé–“å‘Šè­¦ ==========
      
      # Alert 12: è¡¨ç©ºé–“ä½¿ç”¨é‡éå¤§ï¼ˆè¶…é 50GBï¼‰
      - alert: TableSizeExcessive
        expr: |
          timescaledb_table_size_bytes > 50 * 1024 * 1024 * 1024
        for: 1h
        labels:
          severity: warning
          component: timescaledb
          category: storage
        annotations:
          summary: "è¡¨ {{ $labels.table_name }} ç©ºé–“ä½¿ç”¨é‡éå¤§"
          description: |
            è¡¨ï¼š{{ $labels.table_name }}
            å¤§å°ï¼š{{ $value }} bytes (> 50GB)
            å»ºè­°æª¢æŸ¥è³‡æ–™ä¿ç•™ç­–ç•¥æ˜¯å¦æ­£å¸¸é‹è¡Œ
      
      # Alert 13: ç´¢å¼•ç©ºé–“ä½¿ç”¨é‡éå¤§ï¼ˆè¶…éè¡¨ç©ºé–“ï¼‰
      - alert: IndexSizeExcessive
        expr: |
          timescaledb_index_size_bytes > timescaledb_table_size_bytes
        for: 1h
        labels:
          severity: warning
          component: timescaledb
          category: storage
        annotations:
          summary: "è¡¨ {{ $labels.table_name }} ç´¢å¼•ç©ºé–“è¶…éè¡¨ç©ºé–“"
          description: |
            è¡¨ï¼š{{ $labels.table_name }}
            ç´¢å¼•å¤§å°ï¼š{{ $value }} bytes
            å¯èƒ½éœ€è¦é‡å»ºç´¢å¼•æˆ–æª¢æŸ¥ç´¢å¼•é…ç½®
      
      # ========== ç›£æ§æœå‹™æœ¬èº«çš„å‘Šè­¦ ==========
      
      # Alert 14: ä¿ç•™ç›£æ§æœå‹™è¶…é 10 åˆ†é˜æœªæª¢æŸ¥
      - alert: RetentionMonitorNotChecking
        expr: |
          (time() - timescaledb_retention_monitor_last_check_timestamp) > 600
        for: 5m
        labels:
          severity: critical
          component: retention_monitor
          category: service
        annotations:
          summary: "è³‡æ–™ä¿ç•™ç›£æ§æœå‹™è¶…é 10 åˆ†é˜æœªåŸ·è¡Œæª¢æŸ¥"
          description: |
            æœ€å¾Œæª¢æŸ¥æ™‚é–“ï¼š{{ $value | humanizeDuration }} å‰
            ç›£æ§æœå‹™å¯èƒ½å·²åœæ­¢é‹è¡Œ
      
      # Alert 15: ä¿ç•™ç›£æ§æª¢æŸ¥åŸ·è¡Œæ™‚é–“éé•·
      - alert: RetentionMonitorSlowCheck
        expr: |
          timescaledb_retention_monitor_check_duration_seconds > 60
        for: 5m
        labels:
          severity: warning
          component: retention_monitor
          category: performance
        annotations:
          summary: "è³‡æ–™ä¿ç•™ç›£æ§æª¢æŸ¥åŸ·è¡Œæ™‚é–“éé•·"
          description: |
            æª¢æŸ¥åŸ·è¡Œæ™‚é•·ï¼š{{ $value }}ç§’
            å¯èƒ½è¡¨ç¤ºè³‡æ–™åº«è² è¼‰éé«˜æˆ–æŸ¥è©¢æ•ˆç‡å•é¡Œ
