# 長期運行測試專用告警規則
# 針對穩定性與性能測試

groups:
  - name: stability_alerts
    interval: 30s
    rules:
      # 容器重啟檢測
      - alert: ContainerRestarted
        expr: |
          changes(container_start_time_seconds[5m]) > 0
        for: 1m
        labels:
          severity: warning
          component: docker
          test_category: stability
        annotations:
          summary: "容器 {{ $labels.name }} 發生重啟"
          description: "容器在過去 5 分鐘內重啟了 {{ $value }} 次"

      # WebSocket 連接中斷
      - alert: WebSocketDisconnected
        expr: |
          up{job="ws-collector"} == 0
        for: 2m
        labels:
          severity: critical
          component: ws-collector
          test_category: stability
        annotations:
          summary: "WebSocket Collector 斷線"
          description: "WebSocket Collector 已斷線超過 2 分鐘"

      # 持續高錯誤率
      - alert: SustainedHighErrorRate
        expr: |
          (
            rate(collector_api_errors_total[30m])
            /
            rate(collector_api_requests_total[30m])
          ) > 0.05
        for: 30m
        labels:
          severity: warning
          component: collector
          test_category: stability
        annotations:
          summary: "持續高 API 錯誤率"
          description: "過去 30 分鐘平均錯誤率：{{ $value | humanizePercentage }}%"

  - name: performance_alerts
    interval: 30s
    rules:
      # CPU 使用率持續過高
      - alert: HighCPUUsage
        expr: |
          (100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
        for: 15m
        labels:
          severity: warning
          component: system
          test_category: performance
        annotations:
          summary: "系統 CPU 使用率過高"
          description: "{{ $labels.instance }} CPU 使用率：{{ $value | humanize }}%（持續 15 分鐘）"

      # 記憶體使用率過高
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 10m
        labels:
          severity: warning
          component: system
          test_category: performance
        annotations:
          summary: "系統記憶體使用率過高"
          description: "記憶體使用率：{{ $value | humanize }}%"

      # 磁碟空間不足
      - alert: LowDiskSpace
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 5m
        labels:
          severity: critical
          component: system
          test_category: performance
        annotations:
          summary: "磁碟空間不足"
          description: "可用空間僅剩 {{ $value | humanize }}%"

      # Redis 記憶體使用過高
      - alert: RedisHighMemory
        expr: |
          (redis_memory_used_bytes / redis_memory_max_bytes > 0.9)
          and
          (redis_memory_max_bytes > 0)
        for: 10m
        labels:
          severity: warning
          component: redis
          test_category: performance
        annotations:
          summary: "Redis 記憶體使用率過高"
          description: "Redis 記憶體使用率：{{ $value | humanizePercentage }}%"

      # PostgreSQL 連線數過多
      - alert: TooManyDatabaseConnections
        expr: |
          pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: warning
          component: database
          test_category: performance
        annotations:
          summary: "PostgreSQL 連線數過多"
          description: "當前連線數：{{ $value }}（建議 < 80）"

      # 資料庫寫入延遲過高
      - alert: HighDatabaseWriteLatency
        expr: |
          histogram_quantile(0.95, rate(collector_db_write_duration_seconds_bucket[5m])) > 1
        for: 10m
        labels:
          severity: warning
          component: database
          test_category: performance
        annotations:
          summary: "資料庫寫入延遲過高"
          description: "P95 寫入延遲：{{ $value | humanizeDuration }}（閾值：1s）"

  - name: data_quality_alerts
    interval: 60s
    rules:
      # 資料時間戳倒退
      - alert: TimestampRegression
        expr: |
          collector_timestamp_regression_total > 0
        for: 5m
        labels:
          severity: critical
          component: quality
          test_category: data_quality
        annotations:
          summary: "檢測到資料時間戳倒退"
          description: "{{ $labels.symbol }} 在 {{ $labels.table }} 出現時間戳倒退"

      # 異常價格跳動
      - alert: AbnormalPriceJump
        expr: |
          abs(collector_price_change_percent) > 10
        for: 1m
        labels:
          severity: warning
          component: quality
          test_category: data_quality
        annotations:
          summary: "檢測到異常價格跳動"
          description: "{{ $labels.symbol }} 價格變化：{{ $value }}%"

      # 交易量異常
      - alert: AbnormalVolume
        expr: |
          (
            collector_volume_current
            /
            avg_over_time(collector_volume_current[1h])
          ) > 5 or
          (
            collector_volume_current
            /
            avg_over_time(collector_volume_current[1h])
          ) < 0.2
        for: 5m
        labels:
          severity: info
          component: quality
          test_category: data_quality
        annotations:
          summary: "交易量異常"
          description: "{{ $labels.symbol }} 交易量異常：{{ $value }}x 正常值"

  - name: resource_trend_alerts
    interval: 300s
    rules:
      # 磁碟空間快速增長
      - alert: RapidDiskGrowth
        expr: |
          predict_linear(node_filesystem_free_bytes{mountpoint="/"}[6h], 24*3600) < 0
        for: 30m
        labels:
          severity: warning
          component: system
          test_category: performance
        annotations:
          summary: "磁碟空間快速消耗"
          description: "依當前趨勢，磁碟將在 24 小時內用盡"

      # 記憶體洩漏檢測
      - alert: PossibleMemoryLeak
        expr: |
          (
            (node_memory_MemAvailable_bytes - node_memory_MemAvailable_bytes offset 6h)
            /
            node_memory_MemAvailable_bytes offset 6h
          ) < -0.2
        for: 1h
        labels:
          severity: warning
          component: system
          test_category: performance
        annotations:
          summary: "可能的記憶體洩漏"
          description: "過去 6 小時可用記憶體減少超過 20%"
