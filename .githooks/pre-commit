#!/bin/bash
# ============================================
# Pre-commit Hook
# ç›®çš„ï¼šåœ¨ commit å‰æª¢æŸ¥ä¸¦ä¿®å¾©å¸¸è¦‹å•é¡Œ
# å®‰è£ï¼šcp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# ============================================

set -e

echo "ðŸ” Running pre-commit checks..."

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æª¢æŸ¥ 1: package.json è®Šæ›´æ™‚æª¢æŸ¥ package-lock.json
echo ""
echo "ðŸ“¦ Checking npm package consistency..."

CHANGED_PACKAGE_JSON=$(git diff --cached --name-only | grep 'package\.json$' || true)

if [ -n "$CHANGED_PACKAGE_JSON" ]; then
    for package_json in $CHANGED_PACKAGE_JSON; do
        dir=$(dirname "$package_json")
        package_lock="$dir/package-lock.json"

        echo "  - Checking $package_json"

        if [ -f "$package_lock" ]; then
            # æª¢æŸ¥ package-lock.json æ˜¯å¦ä¹Ÿè¢« staged
            if ! git diff --cached --name-only | grep -q "^$package_lock$"; then
                echo -e "${YELLOW}âš ï¸  Warning: $package_json changed but $package_lock not staged${NC}"
                echo "  ðŸ’¡ Tip: Run 'npm install' in $dir to update package-lock.json"

                read -p "  Auto-update package-lock.json and stage it? (y/N): " -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                    (cd "$dir" && npm install)
                    git add "$package_lock"
                    echo -e "${GREEN}âœ“ Updated and staged $package_lock${NC}"
                else
                    echo -e "${YELLOW}âš ï¸  Proceeding without updating package-lock.json${NC}"
                fi
            else
                echo -e "${GREEN}âœ“ $package_lock is staged${NC}"
            fi
        else
            echo -e "${YELLOW}âš ï¸  $package_lock does not exist${NC}"
        fi
    done
fi

# æª¢æŸ¥ 2: ç¢ºä¿ .env.example èˆ‡å¯¦éš›ä½¿ç”¨çš„ç’°å¢ƒè®Šæ•¸åŒæ­¥
echo ""
echo "ðŸ” Checking environment variables..."

if git diff --cached --name-only | grep -q '\.env\.example$'; then
    echo -e "${GREEN}âœ“ .env.example updated${NC}"
fi

# æª¢æŸ¥ 3: ç¢ºä¿ migrations æœ‰æ­£ç¢ºçš„å‘½åé †åº
echo ""
echo "ðŸ—„ï¸  Checking database migrations..."

CHANGED_MIGRATIONS=$(git diff --cached --name-only | grep 'database/migrations/.*\.sql$' || true)

if [ -n "$CHANGED_MIGRATIONS" ]; then
    echo "  Migrations changed:"
    for migration in $CHANGED_MIGRATIONS; do
        echo "    - $(basename $migration)"
    done

    # æª¢æŸ¥å‘½åæ ¼å¼
    for migration in $CHANGED_MIGRATIONS; do
        filename=$(basename "$migration")
        if ! [[ $filename =~ ^[0-9]{3}_.+\.sql$ ]]; then
            echo -e "${RED}âœ— Invalid migration name: $filename${NC}"
            echo "  Migration files should be named like: 001_description.sql"
            exit 1
        fi
    done

    echo -e "${GREEN}âœ“ Migration naming is correct${NC}"
fi

# æª¢æŸ¥ 4: TypeScript/JavaScript èªžæ³•æª¢æŸ¥ï¼ˆå¦‚æžœå®‰è£äº†å·¥å…·ï¼‰
echo ""
echo "ðŸ”§ Checking TypeScript/JavaScript syntax..."

# data-collector TypeScript æª¢æŸ¥
if git diff --cached --name-only | grep -q 'data-collector/src/.*\.ts$'; then
    if [ -d "data-collector/node_modules" ]; then
        echo "  - Running TypeScript compiler check..."
        (cd data-collector && npx tsc --noEmit) || {
            echo -e "${RED}âœ— TypeScript compilation errors found${NC}"
            exit 1
        }
        echo -e "${GREEN}âœ“ TypeScript check passed${NC}"
    else
        echo -e "${YELLOW}âš ï¸  node_modules not found, skipping TypeScript check${NC}"
    fi
fi

# æª¢æŸ¥ 5: Python èªžæ³•æª¢æŸ¥ï¼ˆåŸºæœ¬ï¼‰
echo ""
echo "ðŸ Checking Python syntax..."

CHANGED_PYTHON=$(git diff --cached --name-only | grep '\.py$' || true)

if [ -n "$CHANGED_PYTHON" ]; then
    for py_file in $CHANGED_PYTHON; do
        if [ -f "$py_file" ]; then
            python3 -m py_compile "$py_file" 2>&1 || {
                echo -e "${RED}âœ— Python syntax error in $py_file${NC}"
                exit 1
            }
        fi
    done
    echo -e "${GREEN}âœ“ Python syntax check passed${NC}"
fi

echo ""
echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo ""
